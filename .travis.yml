language: generic

os:
  - osx
  - linux

sudo: false

env:
  global:
    secure: "ZnEdu0lLBRXVLnqSU9duTu+IjSnPs0YOkfvcyspbpI8OewCx+g5DiWRCjcU9GOGscoYoMdTUOwh/E6CloEhAlxaOxtAK4yKFhewu2bUwnZTWwoL+AL9pJZ9z1jUHAU5asAcganYP691g0YO/O9y7h2OedGrmAjDSigdAHE/FtgBuXANfJAIN78cP899XwYQyWYZmeLNtWTKD2kpKv1Z6Y5ivp7cmjn19wwLJekShNMEe2CiTY44rkwwHXNPuoKELQZEE+8TJdFbLm7rh5weucOqtvWuXr0BFS9Kbw/SLKZUWfnrZ9GttNRE7Gi+R/NhXWRIZw4rSkl0njw4jFu/tmojHDAq874hEWqLIjrdrWAqs9ee3JmfcyQQzWPiGIlshiilPC/nyV7Oo45RlPZiceMac5u05kjA1WLGzXnHHdQmfZ8/M7szGLN+jmFE0vYajM9mYihKWhQpIkPVVIEe2k6eRt06zoBqAP4yP/9SIOgW4ik+gwnCWflNEA2vGZV2+s+5KQ7Q8FB+9XjghUY8LooUNGkzasy7vjizaOIt4c2fC3cYQB2Lxhf0L6ulhB7v/u4SSi55bjGm3vI/SNA0pbXVFVaclsaBuTV4dLItRpjyy0quNPdji2oQEBKW58R9rB8Kv7YcHyv2ozty40p5nMutoWWQ3wy2BgsYkxWVcaY4="

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
       brew remove --ignore-dependencies --force $(brew list) ;
    fi

install:
  # Install miniconda.
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then URL="https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh" ; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then URL="https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh" ; fi
  - curl -L $URL -o miniconda.sh
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda config --set show_channel_urls true
  - conda update --quiet conda

  # This numpy variable is not used, but conda-build complains if we haven't set it already.
  - export CONDA_NPY=19
  - conda config --add channels odm2
  - conda install --yes conda-build-all
  # https://github.com/SciTools/conda-build-all/issues/79
  - conda install --yes conda==4.2.16

  - conda info

  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      conda env create --file environment.yml ;
      source activate ODM2 ;
    fi

script:
  - if [[ "$BINSTAR_TOKEN" == "" ]]; then
      export UPLOAD="";
    else
      export UPLOAD="--upload-channels odm2";
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      conda-build-all ./recipes $UPLOAD --inspect-channels odm2 --matrix-conditions "numpy >=1.11" "python >=2.7,<3|>=3.5,<=3.6" ;
    fi

  # Packages integration tests via user notebooks.
  - if [[ "$TEST_TARGET" == "linux" ]]; then
      cd tests && python test_notebooks.py ;
    fi
